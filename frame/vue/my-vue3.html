<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写vue3 | 答案的前端博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8cb9eb99.css" as="style"><link rel="preload" href="/blog/assets/js/app.8d2d898d.js" as="script"><link rel="preload" href="/blog/assets/js/2.f81d762c.js" as="script"><link rel="preload" href="/blog/assets/js/5.f796fdc3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f0b2174c.js"><link rel="prefetch" href="/blog/assets/js/11.e2fb9551.js"><link rel="prefetch" href="/blog/assets/js/12.b26fb97d.js"><link rel="prefetch" href="/blog/assets/js/13.fe1cee7a.js"><link rel="prefetch" href="/blog/assets/js/14.a67526d0.js"><link rel="prefetch" href="/blog/assets/js/15.95b9360c.js"><link rel="prefetch" href="/blog/assets/js/16.1026e9aa.js"><link rel="prefetch" href="/blog/assets/js/17.1856d985.js"><link rel="prefetch" href="/blog/assets/js/18.7924e289.js"><link rel="prefetch" href="/blog/assets/js/19.949e12c0.js"><link rel="prefetch" href="/blog/assets/js/20.7384514d.js"><link rel="prefetch" href="/blog/assets/js/21.cc5e2f49.js"><link rel="prefetch" href="/blog/assets/js/22.f9afa45b.js"><link rel="prefetch" href="/blog/assets/js/23.9e124bdb.js"><link rel="prefetch" href="/blog/assets/js/24.fc79400f.js"><link rel="prefetch" href="/blog/assets/js/25.9fe4ad92.js"><link rel="prefetch" href="/blog/assets/js/26.9618cc8d.js"><link rel="prefetch" href="/blog/assets/js/27.2a86e972.js"><link rel="prefetch" href="/blog/assets/js/28.c3c640f6.js"><link rel="prefetch" href="/blog/assets/js/29.4cc5d136.js"><link rel="prefetch" href="/blog/assets/js/3.88e15477.js"><link rel="prefetch" href="/blog/assets/js/30.ead36335.js"><link rel="prefetch" href="/blog/assets/js/31.e0a4afa9.js"><link rel="prefetch" href="/blog/assets/js/32.36fecadf.js"><link rel="prefetch" href="/blog/assets/js/33.5460ac62.js"><link rel="prefetch" href="/blog/assets/js/34.fad4f5eb.js"><link rel="prefetch" href="/blog/assets/js/35.64da28bf.js"><link rel="prefetch" href="/blog/assets/js/36.a78f507b.js"><link rel="prefetch" href="/blog/assets/js/37.c72cbb75.js"><link rel="prefetch" href="/blog/assets/js/38.f34d46d1.js"><link rel="prefetch" href="/blog/assets/js/39.fb527b4e.js"><link rel="prefetch" href="/blog/assets/js/4.5abc34ba.js"><link rel="prefetch" href="/blog/assets/js/40.80ce4db3.js"><link rel="prefetch" href="/blog/assets/js/41.c8a226eb.js"><link rel="prefetch" href="/blog/assets/js/42.d916cfd1.js"><link rel="prefetch" href="/blog/assets/js/43.64db01ac.js"><link rel="prefetch" href="/blog/assets/js/44.d9d3a5d8.js"><link rel="prefetch" href="/blog/assets/js/45.648e08f5.js"><link rel="prefetch" href="/blog/assets/js/46.c4964d60.js"><link rel="prefetch" href="/blog/assets/js/47.b71119a9.js"><link rel="prefetch" href="/blog/assets/js/48.52feb3f6.js"><link rel="prefetch" href="/blog/assets/js/49.9a646cd8.js"><link rel="prefetch" href="/blog/assets/js/50.d3e99b34.js"><link rel="prefetch" href="/blog/assets/js/51.d85d6898.js"><link rel="prefetch" href="/blog/assets/js/52.7d165847.js"><link rel="prefetch" href="/blog/assets/js/53.2bf60b59.js"><link rel="prefetch" href="/blog/assets/js/54.bfbc3879.js"><link rel="prefetch" href="/blog/assets/js/55.85f9ca55.js"><link rel="prefetch" href="/blog/assets/js/56.20702fe9.js"><link rel="prefetch" href="/blog/assets/js/57.96af5ec8.js"><link rel="prefetch" href="/blog/assets/js/58.1ef81ce4.js"><link rel="prefetch" href="/blog/assets/js/59.b43c672c.js"><link rel="prefetch" href="/blog/assets/js/6.f322345b.js"><link rel="prefetch" href="/blog/assets/js/60.ae342861.js"><link rel="prefetch" href="/blog/assets/js/61.be7d1090.js"><link rel="prefetch" href="/blog/assets/js/62.04fc223c.js"><link rel="prefetch" href="/blog/assets/js/63.ca698552.js"><link rel="prefetch" href="/blog/assets/js/64.b60fda38.js"><link rel="prefetch" href="/blog/assets/js/65.b0ab85da.js"><link rel="prefetch" href="/blog/assets/js/66.b841f143.js"><link rel="prefetch" href="/blog/assets/js/67.4ec47c92.js"><link rel="prefetch" href="/blog/assets/js/7.555de9ef.js"><link rel="prefetch" href="/blog/assets/js/8.1fd21412.js"><link rel="prefetch" href="/blog/assets/js/9.1ba6d461.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8cb9eb99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">答案的前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/basic/" class="nav-link">
    基础篇
  </a></div><div class="nav-item"><a href="/blog/frame/" class="nav-link router-link-active">
    框架篇
  </a></div><div class="nav-item"><a href="/blog/browser/" class="nav-link">
    浏览器
  </a></div><div class="nav-item"><a href="/blog/engine/" class="nav-link">
    工程化
  </a></div><div class="nav-item"><a href="/blog/resume.html" class="nav-link">
    简历
  </a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/basic/" class="nav-link">
    基础篇
  </a></div><div class="nav-item"><a href="/blog/frame/" class="nav-link router-link-active">
    框架篇
  </a></div><div class="nav-item"><a href="/blog/browser/" class="nav-link">
    浏览器
  </a></div><div class="nav-item"><a href="/blog/engine/" class="nav-link">
    工程化
  </a></div><div class="nav-item"><a href="/blog/resume.html" class="nav-link">
    简历
  </a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/blog/frame/react/" class="sidebar-heading clickable"><span>React</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/frame/vue/" class="sidebar-heading clickable router-link-active open"><span>vue</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/frame/vue/" aria-current="page" class="sidebar-link">基础</a></li><li><a href="/blog/frame/vue/my-vue2.html" class="sidebar-link">手写vue2</a></li><li><a href="/blog/frame/vue/my-vue2-router.html" class="sidebar-link">手写vue2-router</a></li><li><a href="/blog/frame/vue/my-vue2-vuex.html" class="sidebar-link">手写vuex(vue2)</a></li><li><a href="/blog/frame/vue/my-vue2-ssr.html" class="sidebar-link">服务端渲染</a></li><li><a href="/blog/frame/vue/my-vue3.html" aria-current="page" class="active sidebar-link">手写vue3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#vue3目录介绍" class="sidebar-link">Vue3目录介绍</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#包的关系" class="sidebar-link">包的关系</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#reactivity" class="sidebar-link">reactivity</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#响应式api" class="sidebar-link">响应式api</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#api" class="sidebar-link">API</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createreactiveobject" class="sidebar-link">createReactiveObject</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#handlers" class="sidebar-link">handlers</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createget" class="sidebar-link">createGet</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createset" class="sidebar-link">createSet</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#了解effect" class="sidebar-link">了解effect</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#effect-副作用" class="sidebar-link">effect：副作用</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createreactiveeffect-创建响应式副作用" class="sidebar-link">createReactiveEffect：创建响应式副作用</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#存在effectstack的原因" class="sidebar-link">存在effectStack的原因</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#track-收集依赖" class="sidebar-link">track: 收集依赖</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#trigger-触发更新" class="sidebar-link">trigger: 触发更新</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#ref" class="sidebar-link">ref</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#ref-shallowref" class="sidebar-link">ref/shallowRef</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createref" class="sidebar-link">createRef</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#toref" class="sidebar-link">toRef</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#torefs" class="sidebar-link">toRefs</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#computed" class="sidebar-link">computed</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#runtime-dom" class="sidebar-link">runtime-dom</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#runtime-core" class="sidebar-link">runtime-core</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createrenderer" class="sidebar-link">createRenderer</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createappapi" class="sidebar-link">createAppApi</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createvnode-创建vnode" class="sidebar-link">createVNode 创建VNode</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#render-渲染" class="sidebar-link">render 渲染</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#patch-核心中的核心" class="sidebar-link">patch: 核心中的核心</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#processtext-处理文本节点" class="sidebar-link">processText：处理文本节点</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#processelement-处理element元素" class="sidebar-link">processElement：处理Element元素</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#mountelement-挂载元素" class="sidebar-link">mountElement：挂载元素</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#mountchildren-挂载子节点-文本-element-组件节点" class="sidebar-link">mountChildren: 挂载子节点(文本/Element/组件节点)</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#patchelement-处理element更新" class="sidebar-link">patchElement: 处理Element更新</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#patchchildren" class="sidebar-link">patchChildren</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#patchkeyedchildren-diff算法-重点之重点" class="sidebar-link">patchKeyedChildren: diff算法(重点之重点)</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#diff01-从左到右" class="sidebar-link">diff01 - 从左到右</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#diff02-从右到左" class="sidebar-link">diff02 - 从右到左</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#diff03-处理新增情况" class="sidebar-link">diff03-处理新增情况</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#diff04-处理删除" class="sidebar-link">diff04-处理删除</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#diff5-乱序处理" class="sidebar-link">diff5 - 乱序处理</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#processcomponent-处理组件" class="sidebar-link">processComponent：处理组件</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#mountcomponent-挂载组件" class="sidebar-link">mountComponent: 挂载组件</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#createcomponentinstance-创建实例" class="sidebar-link">createComponentInstance: 创建实例</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#setupcomponent" class="sidebar-link">setupComponent</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#setupstatefulcomponent-调用有状态的组件" class="sidebar-link">setupStatefulComponent：调用有状态的组件</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#handlesetupresult-处理setup的返回值" class="sidebar-link">handleSetupResult: 处理setup的返回值</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#finishcomponentsetup-确保有个render" class="sidebar-link">finishComponentSetup: 确保有个render</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#setuprendereffect初始化渲染副作用函数" class="sidebar-link">setupRenderEffect初始化渲染副作用函数</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#queuejob-异步更新" class="sidebar-link">queueJob: 异步更新</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#updatecomponent-组件的更新" class="sidebar-link">updateComponent：组件的更新</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#生命钩子调用" class="sidebar-link">生命钩子调用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#compiler-dom" class="sidebar-link">compiler-dom</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#编译过程" class="sidebar-link">编译过程</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#block-block-tree" class="sidebar-link">block -&gt; block tree</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#patchflags-对不同的动态节点进行描述" class="sidebar-link">patchFlags 对不同的动态节点进行描述</a></li><li class="sidebar-sub-header"><a href="/blog/frame/vue/my-vue3.html#性能优化" class="sidebar-link">性能优化</a></li></ul></li></ul></li></ul></section></li><li><a href="/blog/frame/qiankun/" class="sidebar-link">乾坤</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="手写vue3"><a href="#手写vue3" class="header-anchor">#</a> 手写vue3</h1> <blockquote><p>在线地址：https://github.com/xuxiaozhou/my-vue3</p></blockquote> <h2 id="vue3目录介绍"><a href="#vue3目录介绍" class="header-anchor">#</a> Vue3目录介绍</h2> <ul><li>packages
<ul><li>reactivity: 响应式</li> <li>runtime-core: 运行时核心</li> <li>runtime-dom: DOM环境的运行</li> <li>shared: 公共函数</li></ul></li> <li>scripts： 脚本</li> <li>rollup.config.js: rollup编译文件</li> <li>tsconfig.json:</li></ul> <h2 id="包的关系"><a href="#包的关系" class="header-anchor">#</a> 包的关系</h2> <img src="/blog/assets/img/vue3.f79b479c.png"> <h2 id="reactivity"><a href="#reactivity" class="header-anchor">#</a> reactivity</h2> <h3 id="响应式api"><a href="#响应式api" class="header-anchor">#</a> 响应式api</h3> <table><thead><tr><th>api</th> <th>作用</th> <th>dep</th></tr></thead> <tbody><tr><td>reactive</td> <td>响应式</td> <td>深层</td></tr> <tr><td>readonly</td> <td>只读</td> <td>深层</td></tr> <tr><td>shallowReactive</td> <td>响应式</td> <td>浅层</td></tr> <tr><td>shallowReadonly</td> <td>只读</td> <td>浅层</td></tr></tbody></table> <img src="/blog/assets/img/vue3-reactive.7482911b.png"> <h3 id="api"><a href="#api" class="header-anchor">#</a> API</h3> <ul><li>通过高阶函数，只需要传入深浅层和对应的proxy的get,set处理即可实现4个方法</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">reactive</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> object<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> reactiveHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对象的任何层都只读</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">readonly</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> object<span class="token operator">&gt;</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> readonlyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对象的浅层响应式，深层不响应</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallowReactiveHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对象的浅层只读，深度只读</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shallowReadonly</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> shallowReadonlyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createreactiveobject"><a href="#createreactiveobject" class="header-anchor">#</a> createReactiveObject</h3> <ul><li>都是采用proxy代理响应式</li> <li>只能代理对象</li> <li>通过reactiveMap和readonlyMap的防止重复代理</li> <li>使用weakMap的作用可以在target被销毁是，weakMap能够同时垃圾回收</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 缓存已经处理过的对象：在target销毁时能被垃圾回收</span>
<span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> isReadonly<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只能处理是对象类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> map <span class="token operator">=</span> isReadonly <span class="token operator">?</span> readonlyMap <span class="token operator">:</span> reactiveMap<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回已经缓存</span>
    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="handlers"><a href="#handlers" class="header-anchor">#</a> handlers</h3> <ul><li>主要是实现4个api不同的get和set</li> <li>封装get和set高阶函数，可以传入不同参数</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> reactiveHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token function">createGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  set<span class="token operator">:</span> <span class="token function">createSet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReactiveHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token function">createGet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  set<span class="token operator">:</span> <span class="token function">createSet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// readonly的设置都返回报错</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token function">createGet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token function">createGet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="createget"><a href="#createget" class="header-anchor">#</a> createGet</h3> <ul><li>创建handler的get</li> <li>track的作用是此对象和此属性收集依赖</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * createGet
 * @param isReadonly 是否只读
 * @param shallow 是否浅层
 * @returns function
 */</span>
<span class="token keyword">function</span> <span class="token function">createGet</span><span class="token punctuation">(</span>isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类比 target[key]</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 非只读，需要收集依赖</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> TrackOptType<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 浅层的就结束</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果是对象，且非浅层的，还是继续递归调用readonly和reactive</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 非对象就直接返回</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createset"><a href="#createset" class="header-anchor">#</a> createSet</h3> <ul><li>设置会判断操作类型：新增或修改
<ul><li>新增：
<ul><li>对象：设置的key不是对象本身已有的属性</li> <li>数组：key为索引，且索引值大于数组本身长度</li></ul></li> <li>修改：新旧值不一样则是修改</li></ul></li> <li>trigger：通知依赖触发更新操作</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * 创建set
 * @param shallow 是否浅层
 * @returns 
 */</span>
<span class="token keyword">function</span> <span class="token function">createSet</span><span class="token punctuation">(</span>shallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取原来值</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置后会返回一个是否成功</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 新增
     *    数组：并且设置索引，并且设置的索引比当前数组的长度还长
     *    对象：设置的key不是对象本身已有的属性
     * 修改
     *    新旧值不一样则是修改
     */</span>
    <span class="token keyword">const</span> hasKey <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isInteger</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token operator">:</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通知：新增操作</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpt<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通知：修改操作</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpt<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回修改结果</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="了解effect"><a href="#了解effect" class="header-anchor">#</a> 了解effect</h3> <blockquote><p>在了解trigger和track之前，先了解effect</p></blockquote> <p>其作用：默认会执行一次，在effect执行函数用到的响应式变量（reactive,readonly,shallowReactive,shallowReadonly,ref,shallowRef包装过）会被收集依赖，当这边变量发生变化是会再次执行此函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token literal-property property">other</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 默认会执行此函数fn</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>  <span class="token comment">// fn</span>
  <span class="token comment">// 使用累reactive包装后的变量</span>
  app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>hello
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token string">'vue'</span>
  <span class="token comment">// 修改后会默认调用fn函数</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="effect-副作用"><a href="#effect-副作用" class="header-anchor">#</a> effect：副作用</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token operator">:</span> EffectOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建响应式</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果没有设置lazy，会立即执行一次</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createreactiveeffect-创建响应式副作用"><a href="#createreactiveeffect-创建响应式副作用" class="header-anchor">#</a> createReactiveEffect：创建响应式副作用</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 存放当前的effect，方便track将target，key和对应的effect关联起来</span>
<span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span>
<span class="token comment">// 存放一个栈形结构，保证activeEffect指向正确</span>
<span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保证不再重复</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effectStack<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        activeEffect <span class="token operator">=</span> effect<span class="token punctuation">;</span>
      
        <span class="token comment">// 其实还是调用传进来的函数</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保证effect永远正确</span>
        effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  effect<span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span><span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>__isEffect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>raw <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="存在effectstack的原因"><a href="#存在effectstack的原因" class="header-anchor">#</a> 存在effectStack的原因</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>  <span class="token comment">// effect1</span>
  state<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token number">1</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>  <span class="token comment">// effect2</span>
    state<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  state<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token number">3</span>   <span class="token comment">// 此处应该存effect1，如果没有当一个effect执行完后重制为数组最后一个，此时存的就是effect1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="track-收集依赖"><a href="#track-收集依赖" class="header-anchor">#</a> track: 收集依赖</h3> <blockquote><p>对象，key和effect需要关联起来</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * 收集依赖，将target,key关联起来
 * @param target 对象
 * @param key  属性
 * @param type 类型
 * @returns 
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此处的activeEffect是跟effect在同一文件。</span>
  <span class="token comment">// 主要利用js是单线程的机制</span>
  <span class="token comment">// 如果当前使用值不在effect里面使用是不需要收集</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/***
  存储的数据结果
  Weakmap {
    [ target ]: Map {
      [ key ] : Set [ effect1, effect2 ]
    }
  }
  */</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> depMap <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> depMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> dep <span class="token operator">=</span> depMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="trigger-触发更新"><a href="#trigger-触发更新" class="header-anchor">#</a> trigger: 触发更新</h3> <ul><li>通过target获取此对象收集的依赖</li> <li>修改数组长度
<ul><li>触发收集length的effect</li> <li>触发收集索引大于length的effect</li></ul></li> <li>修改
<ul><li>触发收集对应key的effect</li></ul></li> <li>如果是数组，且是新增操作
<ul><li>触发收集length的effect</li></ul></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * 触发更新
 * @param target 对象
 * @param type 更新类型
 * @param key 属性
 * @param newValue 新值
 * @param oldValue 旧值
 * @returns 
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> newValue<span class="token operator">?</span><span class="token punctuation">,</span> oldValue<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此对象没被依赖收集就不需要处理</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 要执行的effect存到新的集合</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span>effectToAdd<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectToAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effectToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>effect <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 修改数组的长度</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">===</span> <span class="token string">'length'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更改长度</span>
      <span class="token comment">// length收集的effects要执行</span>
      <span class="token comment">// 大于新设置长度的索引收集的effects也要执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">isNumber</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 修改</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> TriggerOpt<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token operator">:</span>
        <span class="token comment">// 数组：新增操作，length收集的effects要执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isInteger</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'length'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 要执行的effects依次执行</span>
  effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// effect不一定都是立即执行的，可能做一下其他事情，比如computed</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token operator">?.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ref"><a href="#ref" class="header-anchor">#</a> ref</h3> <h4 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h4> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> name<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">'---'</span> <span class="token operator">+</span> age<span class="token punctuation">.</span>value<span class="token punctuation">.</span>num
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'world'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  age<span class="token punctuation">.</span>value<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">20</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h4> <ul><li>针对reactive等不支持对象的形式支持</li> <li>支持除了普通类型也是支持引用类型</li> <li>使用<code>.value</code></li> <li>使用的Object.defineProperty去实现对value的响应式</li></ul> <h3 id="ref-shallowref"><a href="#ref-shallowref" class="header-anchor">#</a> ref/shallowRef</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 传进来的是普通值</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 传进来的是普通值</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createref"><a href="#createref" class="header-anchor">#</a> createRef</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isShallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isShallow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果是对象则采用reactive</span>
<span class="token keyword">const</span> <span class="token function-variable function">convert</span> <span class="token operator">=</span> val <span class="token operator">=&gt;</span> <span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存放处理过的值</span>
  <span class="token keyword">public</span> _value<span class="token punctuation">;</span>
  <span class="token comment">// 存放原值</span>
  <span class="token keyword">public</span> _rawValue<span class="token punctuation">;</span>
  <span class="token keyword">private</span> isShallow<span class="token punctuation">;</span>
  <span class="token comment">// 增加标识</span>
  <span class="token keyword">public</span> _v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isShallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是深度且是对象，只用reactive去处理响应式</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> isShallow <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token function">convert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存原值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isShallow <span class="token operator">=</span> isShallow<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 收集此对象的 value 字段的依赖</span>
    <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> TrackOptType<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否有改变</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token comment">// 如果非浅层，则判断是否是对象，如果是对象则进行调用reactive</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isShallow <span class="token operator">?</span> newValue <span class="token operator">:</span> <span class="token function">convert</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 触发此对象 设置 value 字段的更新</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TriggerOpt<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="toref"><a href="#toref" class="header-anchor">#</a> toRef</h3> <h4 id="使用-2"><a href="#使用-2" class="header-anchor">#</a> 使用</h4> <blockquote><p>将响应式对象的某个属性转成<code>ref</code></p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'allen'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> name<span class="token punctuation">.</span>value
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'tom'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h4> <ul><li>只是做一个层代理</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">ObjectRefImpl</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> _v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> target<span class="token punctuation">;</span>
  <span class="token keyword">public</span> key<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 传进来的是响应式对象</span>
<span class="token comment">// 将一个响应式对象的属性变成ref</span>
<span class="token comment">// 代理了对象的属性</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toRef</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjectRefImpl</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="torefs"><a href="#torefs" class="header-anchor">#</a> toRefs</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 传进来的是响应式对象</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="computed"><a href="#computed" class="header-anchor">#</a> computed</h3> <h4 id="使用-3"><a href="#使用-3" class="header-anchor">#</a> 使用</h4> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> myAge <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'runner'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> age<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">10</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 第一次获取，会走函数</span>
<span class="token comment">// runner</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myAge<span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token comment">// 28</span>
<span class="token comment">// 这次computed依赖项没有修改，则不走函数，直接读缓存的值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myAge<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 28</span>

<span class="token comment">// 修改age，computed依赖项发生改变，但不会立即执行，需要等待下次取值才会走函数</span>
age<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">10</span>
<span class="token comment">// 还没更新</span>
<span class="token comment">// {&quot;_dirty&quot;:true,&quot;_value&quot;:28}</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>myAge<span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token comment">// 因为依赖项发生改变，会重新执行</span>
<span class="token comment">// runner</span>
<span class="token comment">// 20</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myAge<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</code></pre></div><h4 id="computed-2"><a href="#computed-2" class="header-anchor">#</a> computed</h4> <ul><li>getterOrOptions可以是函数/对象</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Getter<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">GetterOption<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> Getter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">GetterOrOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> Getter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> GetterOption<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>getterOrOptions<span class="token operator">:</span> GetterOrOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> getter<span class="token punctuation">;</span>
  <span class="token keyword">let</span> setter<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">;</span>
    <span class="token function-variable function">setter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'no change'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> <span class="token punctuation">(</span>getterOrOptions <span class="token keyword">as</span> GetterOption<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">;</span>
    setter <span class="token operator">=</span> <span class="token punctuation">(</span>getterOrOptions <span class="token keyword">as</span> GetterOption<span class="token punctuation">)</span><span class="token punctuation">.</span>set<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComputedRefImpl</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> setter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="computedrefimpl"><a href="#computedrefimpl" class="header-anchor">#</a> ComputedRefImpl</h4> <ul><li>computed基于effect</li> <li>通过_dirty是否使用缓存值还是重新计算</li> <li>computed的值通过<code>.value</code></li> <li>computed本身函数默认不执行，只有获取值是去调用</li> <li>但computed依赖项没有发生改变时，不去走计算函数，直接使用缓存的值</li> <li>但依赖项发生改变，不会立即执行。下次获取获取值是才会重新计算</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// effect的执行由自己控制什么时候执行</span>
<span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">{</span>
  <span class="token comment">// 需不需要重新计算的标识符</span>
  <span class="token keyword">public</span> _dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 存储最新的值</span>
  <span class="token keyword">public</span> _value<span class="token punctuation">;</span>
  <span class="token keyword">public</span> setter<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> effect<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>setter <span class="token operator">=</span> setter<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不是立即执行</span>
      lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// 调度</span>
      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 设置下次get的时候执行重新获取最新的值</span>
          <span class="token comment">// 修改this._dirty,在下次获取时就可以去获取新值</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token comment">// 触发收集这个依赖的effect</span>
          <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TriggerOpt<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓存起来，不是每个获取都是去走effect的</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 收集依赖</span>
    <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> TrackOptType<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="runtime-dom"><a href="#runtime-dom" class="header-anchor">#</a> runtime-dom</h2> <ul><li>将dom操作等平台相关操作作为参数传入给createRenderer,是runtime-core是与平台无关</li> <li>重写mount的原因是进行一些平台相关业务操作</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 渲染用到的方法：</span>
<span class="token comment">// 跟平台相关的api</span>
<span class="token comment">// 创建dom，修改dom属性等</span>
<span class="token keyword">const</span> rendererOptions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>nodeOps<span class="token punctuation">,</span> patchProp <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span>rendererOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token comment">// 重写mount，执行一些跟平台相关的操作</span>
  app<span class="token punctuation">.</span><span class="token function-variable function">mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取真实dom</span>
    container <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清空</span>
    container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token comment">// 才是真正的挂载</span>
    <span class="token function">mount</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 导出runtime-core</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'@vue/runtime-core'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="runtime-core"><a href="#runtime-core" class="header-anchor">#</a> runtime-core</h2> <img src="/blog/assets/img/vue3-patch.ce3e2022.png"> <blockquote><p>结合runtime-dom调用</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">createRenderer</span><span class="token punctuation">(</span>rendererOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="createrenderer"><a href="#createrenderer" class="header-anchor">#</a> createRenderer</h3> <blockquote><p>runtime-core/renderer.ts</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 创建渲染器</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span>rendererOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 核心代码: 在此函数内能获取到平台相关的操作方法，减少传递</span>
  <span class="token comment">// 。。。</span>

  <span class="token comment">// 渲染</span>
  <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用createAppApi返回createApp，同时传递render</span>
    createApp<span class="token operator">:</span> <span class="token function">createAppApi</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createappapi"><a href="#createappapi" class="header-anchor">#</a> createAppApi</h3> <blockquote><p>runtime-core/createAppApi</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createAppApi</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根组件，根组件的props</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span>
      _props<span class="token operator">:</span> rootProps<span class="token punctuation">,</span>
      _component<span class="token operator">:</span> rootComponent<span class="token punctuation">,</span>
      _container<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token function">mount</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建虚拟节点</span>
        <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用render</span>
        <span class="token function">render</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>

        app<span class="token punctuation">.</span>_container <span class="token operator">=</span> container<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createvnode-创建vnode"><a href="#createvnode-创建vnode" class="header-anchor">#</a> createVNode 创建VNode</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 目前只考虑元素和组件</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 标识：为后期patch比较提供便利</span>
  <span class="token keyword">const</span> shapeFlag <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
    <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否是vnode</span>
    _v_isVnode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>

    key<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>key<span class="token punctuation">,</span>

    <span class="token comment">// 真实的节点</span>
    el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 实例</span>
    component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    shapeFlag
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 根据children标识</span>
  <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> vnode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置children的类型</span>
<span class="token keyword">function</span> <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">|=</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="render-渲染"><a href="#render-渲染" class="header-anchor">#</a> render 渲染</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 调用patch</span>
<span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="patch-核心中的核心"><a href="#patch-核心中的核心" class="header-anchor">#</a> patch: 核心中的核心</h3> <blockquote><p>挂载和更新组件/元素都走此方法</p></blockquote> <ul><li>n1为null是代表走挂载流程</li> <li>否则走更新流程</li> <li>如果新旧VNode的类型不一样，则把旧VNode干掉，重新走挂载流程</li> <li>根据VNode不同类型做不同操作</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
  * 打补丁：挂载和更新的功能
  * @param n1 旧节点
  * @param n2 新节点
  * @param container 挂载容器
  * @param anchor 当前元素的参照物
  */</span>
<span class="token keyword">const</span> <span class="token function-variable function">patch</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> shapeFlag<span class="token punctuation">,</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span>

  <span class="token comment">// 如果有旧vnode，且不是相同类型：直接把旧节点干掉，走挂载的流程</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  删除以前，换成新的</span>
    anchor <span class="token operator">=</span> <span class="token function">hostNextSibling</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据不同类型，做不同操作</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">TEXT</span><span class="token operator">:</span>
      <span class="token comment">// 文本节点，特殊处理</span>
      <span class="token function">processText</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 元素</span>
        <span class="token function">processElement</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 组件</span>
        <span class="token function">processComponent</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="processtext-处理文本节点"><a href="#processtext-处理文本节点" class="header-anchor">#</a> processText：处理文本节点</h3> <ul><li>n1为null时，走挂载流程</li> <li>n1不为null时，走更新流程</li> <li>hostCreateText/hostInsert/hostSetText等方法则是调用createRenderer传递的参数</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">processText</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 挂载</span>
    <span class="token comment">// 新建文本节点</span>
    n2<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateText</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 插入父容器</span>
    <span class="token function">hostInsert</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新：复用旧节点的元素</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el<span class="token punctuation">;</span>
    <span class="token comment">// 比较新旧文本节点的children是否一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token operator">!==</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不同只重新设置文本内容</span>
      <span class="token function">hostSetText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="processelement-处理element元素"><a href="#processelement-处理element元素" class="header-anchor">#</a> processElement：处理Element元素</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">processElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素挂载</span>
    <span class="token function">mountElement</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素更新</span>
    <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="mountelement-挂载元素"><a href="#mountelement-挂载元素" class="header-anchor">#</a> mountElement：挂载元素</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">mountElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> shapeFlag<span class="token punctuation">,</span> type<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>

  <span class="token comment">// 创建元素</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理元素children</span>
  <span class="token comment">// 1. children为文本节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 文本内容</span>
    <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2. 元素数组</span>
    <span class="token function">mountChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 挂载到容器上</span>
  <span class="token function">hostInsert</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="mountchildren-挂载子节点-文本-element-组件节点"><a href="#mountchildren-挂载子节点-文本-element-组件节点" class="header-anchor">#</a> mountChildren: 挂载子节点(文本/Element/组件节点)</h3> <blockquote><p>递归调用patch</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 挂载子节点</span>
<span class="token keyword">const</span> <span class="token function-variable function">mountChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span>children<span class="token punctuation">,</span> el<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 标准化子VNode</span>
    <span class="token comment">// 如果是字符串：则生成文本节点</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用patch进行分别挂载</span>
    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="patchelement-处理element更新"><a href="#patchelement-处理element更新" class="header-anchor">#</a> patchElement: 处理Element更新</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">patchElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 复用dom节点</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新属性</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新子节点</span>
  <span class="token function">patchChildren</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="patchchildren"><a href="#patchchildren" class="header-anchor">#</a> patchChildren</h3> <ul><li>新的是文本
<ul><li>旧的是数组：卸载旧节点, 设置文本节点children</li></ul></li> <li>旧的是数组
<ul><li>新的是数组：走patchKeyedChildren,diff算法</li> <li>新的为null：卸载旧节点</li></ul></li> <li>旧的是文本，新的是新数组
<ul><li>重写旧节点children</li> <li>挂载新数组</li></ul></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">patchChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> c1 <span class="token operator">=</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token keyword">const</span> c2 <span class="token operator">=</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token comment">// 类型</span>
  <span class="token keyword">const</span> prevShapeFlag <span class="token operator">=</span> n1<span class="token punctuation">.</span>shapeFlag<span class="token punctuation">;</span>
  <span class="token keyword">const</span> shapeFlag <span class="token operator">=</span> n2<span class="token punctuation">.</span>shapeFlag<span class="token punctuation">;</span>

  <span class="token comment">// 新的是文本</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 旧的是数组，卸载</span>
      <span class="token function">unmountChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1 <span class="token operator">!==</span> c2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新旧children不一致重新设置</span>
      <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 旧的是数组</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 两次都是数组</span>
      <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 老的没有孩子, null</span>
      <span class="token function">unmountChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 旧的是文本, 新的是非文本</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mountChildren</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="patchkeyedchildren-diff算法-重点之重点"><a href="#patchkeyedchildren-diff算法-重点之重点" class="header-anchor">#</a> patchKeyedChildren: diff算法(重点之重点)</h3> <h3 id="diff01-从左到右"><a href="#diff01-从左到右" class="header-anchor">#</a> diff01 - 从左到右</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">c1<span class="token punctuation">,</span> c2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token comment">// 从左往右，一次比较是否是相同类型，遇到第一个不同类型则跳出循环</span>

  <span class="token comment">// (a b) c d</span>
  <span class="token comment">// (a b) e c d</span>
  <span class="token comment">// i = 2, e1 = 3 , e2 = 4</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行patch操作</span>
      i <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/blog/assets/img/diff1.cdea64b9.png"> <h3 id="diff02-从右到左"><a href="#diff02-从右到左" class="header-anchor">#</a> diff02 - 从右到左</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token comment">// 从左往右</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// 从右往左</span>
  <span class="token comment">// i = 2, e1 = 1, e2 = 2</span>
  <span class="token comment">// a b (c d)</span>
  <span class="token comment">// a b e (c d)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span> <span class="token operator">===</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e1 <span class="token operator">-=</span> <span class="token number">1</span>
      e2 <span class="token operator">-=</span> <span class="token number">1</span>
      <span class="token comment">// 执行patch操作</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/blog/assets/img/diff2.dd156d9b.png"> <h3 id="diff03-处理新增情况"><a href="#diff03-处理新增情况" class="header-anchor">#</a> diff03-处理新增情况</h3> <ul><li>条件：<code>i &gt; e1</code>且<code>i &lt;= e2</code></li> <li>新增部分 <code>[i, e2]</code></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token comment">// 从左往右</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从右往左</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. 新增</span>

      <span class="token comment">// 1.0 前新增</span>
      <span class="token comment">// (a b c d)</span>
      <span class="token comment">// f (a b c d)</span>
      <span class="token comment">// i = 0, e1 = -1, e2 = 0     ===&gt; i&gt; e1 且 [i, e2]部分为新增</span>

      <span class="token comment">// 1.1 中间新增</span>
      <span class="token comment">// (a b) (c d)</span>
      <span class="token comment">// (a b) e (c d)</span>
      <span class="token comment">// i =2, e1=1, e2=2   ===&gt; i&gt; e1 且 [i,e2]部分为新增</span>

      <span class="token comment">// 1.2 后新增</span>
      <span class="token comment">// (a, b, c, d)</span>
      <span class="token comment">// (a, b, c, d), e, f</span>
      <span class="token comment">// i = 4, e1 = 4, e2 = 6 ===&gt;i&gt; e1 且 [i,e2]部分为新增</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新增</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增'</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        i<span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/blog/assets/img/diff3.4ec248b6.png"> <h3 id="diff04-处理删除"><a href="#diff04-处理删除" class="header-anchor">#</a> diff04-处理删除</h3> <blockquote><p>条件 i&gt;e2 ,删除的[i,e1]</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token comment">// 从左往右</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从右到左</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新增: [i, e2]</span>
      <span class="token comment">// 。。。</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 后面删除</span>
    <span class="token comment">// ['a', 'b', 'c', 'd', 'e', 'f']</span>
    <span class="token comment">// ['a', 'b', 'c', 'd']</span>
    <span class="token comment">// i= 4. e1 =5, e2 = 3, (i &gt; e2，且删除 [i,e1])</span>

    <span class="token comment">// 中间删除</span>
    <span class="token comment">// ['a', 'b', 'e', 'c', 'd']</span>
    <span class="token comment">// ['a', 'b', 'c', 'd']</span>
    <span class="token comment">// i = 2，e1 = 2, e2 = 1 (i &gt; e2 且 删除[i,e1])</span>

    <span class="token comment">// 前面删除</span>
    <span class="token comment">// ['f', 'a', 'b', 'c', 'd']</span>
    <span class="token comment">// ['a', 'b', 'c', 'd']</span>
    <span class="token comment">// i=0, e1 =0, e2=-1 (i&gt; e2 ,且删除 [i,e1])</span>

    <span class="token comment">// 删除: [i, e1]</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除'</span><span class="token punctuation">,</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      i<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/blog/assets/img/diff4.44469540.png"> <h3 id="diff5-乱序处理"><a href="#diff5-乱序处理" class="header-anchor">#</a> diff5 - 乱序处理</h3> <div class="language- extra-class"><pre class="language-text"><code>['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'],
['a', 'b', 'e', 'c', 'd', 'i', 'g', 'h'],
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token comment">// 从左往右，一次比较是否是相同类型，遇到第一个不同类型则跳出循环</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从右到左</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新增: [i, e2]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删除: [i, e1]</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// i = 2, e1 = 5, e2 = 5</span>
    <span class="token comment">// ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'],</span>
    <span class="token comment">// ['a', 'b', 'e', 'c', 'd', 'i', 'g', 'h'],</span>

    <span class="token comment">// 待处理部分： [s1,e1] [s2,e2]</span>
    <span class="token comment">// ['c', 'd', 'e', 'f']</span>
    <span class="token comment">// ['e', 'c', 'd', 'i']</span>

    <span class="token comment">// 旧索引开始 2</span>
    <span class="token keyword">const</span> s1 <span class="token operator">=</span> i
    <span class="token comment">// 新索引开始 2</span>
    <span class="token keyword">const</span> s2 <span class="token operator">=</span> i

    <span class="token comment">// 用新的元素做映视表，Map{key: index}</span>
    <span class="token comment">// 如果在旧的元素找不到则是删除</span>
    <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s2<span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span>i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Map { 'e' =&gt; 2, 'c' =&gt; 3, 'd' =&gt; 4, 'i' =&gt; 5 }</span>
    <span class="token comment">// console.log(keyToNewIndexMap)</span>

    <span class="token comment">// 新数组中需要处理的个数： 4</span>
    <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token comment">// [0,0,0,0]</span>
    <span class="token comment">// 索引代表 在新数组的索引</span>
    <span class="token comment">// 值代表： 在旧数组的索引</span>
    <span class="token keyword">const</span> newIndexToOldIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>toBePatched<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token comment">// 从旧的元素查找是否是删除或是复用</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s1<span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span>i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> old <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 卸载：新的没有，旧的有</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unmount'</span><span class="token punctuation">,</span> old<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新的索引 =&gt; 旧的索引</span>
        <span class="token comment">// [5,3,4,0]</span>
        newIndexToOldIndexMap<span class="token punctuation">[</span>newIndex <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token comment">// 新位置索引小于最大索引，证明需要移动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          maxNewIndexSoFar <span class="token operator">=</span> newIndex
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          moved <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 做patch</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 倒序</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> toBePatched <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentIndex <span class="token operator">=</span> i <span class="token operator">+</span> s2

      <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增'</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 做最长增长序列去优化移动</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'move'</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="processcomponent-处理组件"><a href="#processcomponent-处理组件" class="header-anchor">#</a> processComponent：处理组件</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 处理组件</span>
<span class="token keyword">const</span> <span class="token function-variable function">processComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 挂载</span>
    <span class="token function">mountComponent</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 组件更新</span>
    <span class="token function">updateComponent</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="mountcomponent-挂载组件"><a href="#mountcomponent-挂载组件" class="header-anchor">#</a> mountComponent: 挂载组件</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">mountComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 核心流程：setup返回值  -&gt; render</span>

  <span class="token comment">// 1.创建实例,根据虚拟节点</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> vnode<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 解析数据解析到实例上</span>
  <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 创建render的effect</span>
  <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="createcomponentinstance-创建实例"><a href="#createcomponentinstance-创建实例" class="header-anchor">#</a> createComponentInstance: 创建实例</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 组件实例</span>
  <span class="token keyword">const</span> instance<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    vnode<span class="token punctuation">,</span>
    type<span class="token operator">:</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    attrs<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    slots<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// setup返回一个对象</span>
    setupState<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    render<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 这个组件是否挂载</span>
    isMounted<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  instance<span class="token punctuation">.</span>ctx <span class="token operator">=</span> <span class="token punctuation">{</span> _<span class="token operator">:</span> instance <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="setupcomponent"><a href="#setupcomponent" class="header-anchor">#</a> setupComponent</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token comment">// todo 插槽</span>
  instance<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">;</span>

  <span class="token keyword">const</span> isStateful <span class="token operator">=</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">;</span>
  <span class="token comment">// 带状态的组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isStateful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用setup</span>
    <span class="token comment">// 并将返回值填充 instance.setupState / instance.render;</span>
    <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="setupstatefulcomponent-调用有状态的组件"><a href="#setupstatefulcomponent-调用有状态的组件" class="header-anchor">#</a> setupStatefulComponent：调用有状态的组件</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 代理, 将data,props,事件代理到instance.proxy</span>
  instance<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> PublicInstanceProxyHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 组件类型</span>
  <span class="token keyword">const</span> Component <span class="token operator">=</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> setup <span class="token punctuation">}</span> <span class="token operator">=</span> Component<span class="token punctuation">;</span>

  <span class="token comment">// 调用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>setup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> setupContext <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 进入setup前设置当前实例</span>
    currentInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span>

    <span class="token keyword">const</span> setupResult <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> setupContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    currentInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token function">handleSetupResult</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> setupResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="handlesetupresult-处理setup的返回值"><a href="#handlesetupresult-处理setup的返回值" class="header-anchor">#</a> handleSetupResult: 处理setup的返回值</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 处理setup返回结果</span>
<span class="token keyword">function</span> <span class="token function">handleSetupResult</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> setupResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>setupResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果setup返回的是函数，则将这个函数作为实例的render</span>
    instance<span class="token punctuation">.</span>render <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>setupResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是对象，则保存为setupState</span>
    instance<span class="token punctuation">.</span>setupState <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="finishcomponentsetup-确保有个render"><a href="#finishcomponentsetup-确保有个render" class="header-anchor">#</a> finishComponentSetup: 确保有个render</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 保证instance有render</span>
<span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Component <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>

  <span class="token comment">// 处理实例还没有render的，则从type中取render</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Component<span class="token punctuation">.</span>render <span class="token operator">&amp;&amp;</span> Component<span class="token punctuation">.</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对template进行模板编译成render</span>
    <span class="token punctuation">}</span>

    instance<span class="token punctuation">.</span>render <span class="token operator">=</span> Component<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="setuprendereffect初始化渲染副作用函数"><a href="#setuprendereffect初始化渲染副作用函数" class="header-anchor">#</a> setupRenderEffect初始化渲染副作用函数</h3> <ul><li>调用instance.render生成subTree</li> <li>调用patch去挂载</li> <li>effect调度方式：异步更新，防止每次同步修改都去更新</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">setupRenderEffect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 组件级更新, 数据更新会重新执行对应组件的effect</span>
  instance<span class="token punctuation">.</span>update <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">componentEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> bm<span class="token punctuation">,</span> m <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>

        <span class="token comment">// beforeMount</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span> proxy <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token comment">// 类比react的classComponent，调用render才是要渲染</span>
        <span class="token keyword">const</span> subTree <span class="token operator">=</span> instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化</span>
        instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> subTree<span class="token punctuation">.</span>el<span class="token punctuation">;</span>

        <span class="token comment">// 执行mounted</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 在微任务去调用mounted</span>
          <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> bu<span class="token punctuation">,</span> u <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span> next <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>

        <span class="token comment">// 用next赋值给</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          next<span class="token punctuation">.</span>el <span class="token operator">=</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">;</span>
          <span class="token function">updateComponentPreRender</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          next <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// beforeUpdate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>bu<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新</span>
        <span class="token keyword">const</span> prevTree <span class="token operator">=</span> instance<span class="token punctuation">.</span>subTree<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> proxy <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token comment">// 记录最新的虚拟dom</span>
        <span class="token keyword">const</span> nextTree <span class="token operator">=</span> instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>prevTree<span class="token punctuation">,</span> nextTree<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// updated</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 调度</span>
      <span class="token comment">// 处理多次调用，只执行一次</span>
      <span class="token comment">// 异步更新, 同步先走完，在一次性执行</span>
      scheduler<span class="token operator">:</span> queueJob
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="queuejob-异步更新"><a href="#queuejob-异步更新" class="header-anchor">#</a> queueJob: 异步更新</h3> <ul><li>在同步执行都会往queue添加effect(去重)</li> <li>在微任务队列中执行queue</li> <li>执行完重置queue和isFlushPending</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">queueJob</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">queueFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> isFlushPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">queueFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFlushPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isFlushPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 在微任务队列才执行effect</span>
    <span class="token comment">// 在调度前，会将所有同步的都会放到queue</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushJobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">flushJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isFlushPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理排序，执行父的再执行子的</span>
  queue<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> job <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 清空</span>
  queue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="updatecomponent-组件的更新"><a href="#updatecomponent-组件的更新" class="header-anchor">#</a> updateComponent：组件的更新</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 更新组件</span>
<span class="token keyword">const</span> <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 复用component</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> n2<span class="token punctuation">.</span>component <span class="token operator">=</span> n1<span class="token punctuation">.</span>component<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldUpdateComponent</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>next <span class="token operator">=</span> n2<span class="token punctuation">;</span>

    <span class="token comment">// 去掉子组件的update队列</span>
    <span class="token function">invalidateJob</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 最后执行一次更新</span>
    instance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 往实例注入生命周期钩子数组</span>
<span class="token keyword">const</span> <span class="token function-variable function">injectHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">,</span> hook<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'不存在instance'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> hooks <span class="token operator">=</span> target<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 确保钩子调用getCurrentInstance时都能获取当前的实例</span>
    <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>wrap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建钩子</span>
<span class="token keyword">const</span> <span class="token function-variable function">createHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lifeCycle<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在调用onBeforeMount()是在setup里面调用, 先把当前的实例缓存起来</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>hook<span class="token punctuation">,</span> target <span class="token operator">=</span> currentInstance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 标记当前实例</span>
    <span class="token function">injectHook</span><span class="token punctuation">(</span>lifeCycle<span class="token punctuation">,</span> hook<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> onBeforeMount <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycleHook<span class="token punctuation">.</span><span class="token constant">BEFORE_MOUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> onMounted <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycleHook<span class="token punctuation">.</span><span class="token constant">MOUNTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> onBeforeUpdate <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycleHook<span class="token punctuation">.</span><span class="token constant">BEFORE_UPDATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> onUpdated <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycleHook<span class="token punctuation">.</span><span class="token constant">UPDATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="生命钩子调用"><a href="#生命钩子调用" class="header-anchor">#</a> 生命钩子调用</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">setupRenderEffect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 组件级更新, 数据更新会重新执行对应组件的effect</span>
  instance<span class="token punctuation">.</span>update <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">componentEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> bm<span class="token punctuation">,</span> m <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>

        <span class="token comment">// beforeMount</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ...</span>

        <span class="token comment">// 执行mounted</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 在微任务去调用mounted</span>
          <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> bu<span class="token punctuation">,</span> u <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>

        <span class="token comment">// ...</span>

        <span class="token comment">// beforeUpdate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>bu<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ...</span>

        <span class="token comment">// updated</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokerArrayFns</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> scheduler<span class="token operator">:</span> queueJob <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 钩子一次执行</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">invokerArrayFns</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fns<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="compiler-dom"><a href="#compiler-dom" class="header-anchor">#</a> compiler-dom</h2> <p>解析 template 生成 AST，AST 转换和生成代码</p> <h3 id="编译过程"><a href="#编译过程" class="header-anchor">#</a> 编译过程</h3> <div class="language- extra-class"><pre class="language-text"><code>https://vue-next-template-explorer.netlify.app/
</code></pre></div><ul><li>先将模板进行分析，生成ast树</li> <li>转换transform -&gt; 对动态节点做一些标记</li> <li>代码生产 codegen</li></ul> <h3 id="block-block-tree"><a href="#block-block-tree" class="header-anchor">#</a> block -&gt; block tree</h3> <ul><li>diff算法，递归遍历，属于全量比对</li> <li>block的作用就是为了收集动态节点</li> <li>在createVnode的时候判断是动态节点后让外层的block进行收集</li> <li>目的是在diff只比较动态节点</li> <li>会标记为block
<ul><li>会影响结构的  v-if</li> <li>序列不稳定 v-for  不收集动态节点</li></ul></li> <li>父会收集儿子block -&gt; blockTree（多个）</li></ul> <h3 id="patchflags-对不同的动态节点进行描述"><a href="#patchflags-对不同的动态节点进行描述" class="header-anchor">#</a> patchFlags 对不同的动态节点进行描述</h3> <h3 id="性能优化"><a href="#性能优化" class="header-anchor">#</a> 性能优化</h3> <ul><li>静态提升</li> <li>事件
<ul><li>缓存事件，防止重新创建事件</li></ul></li> <li>template和jsx
<ul><li>template简单（模板编译优化）</li> <li>jsx灵活（没有模板编译优化）</li></ul></li> <li>proxy -&gt; defineProperty
<ul><li>懒递归</li></ul></li> <li>vue3 diff算法（可以根据patchFlag做diff）和vue2（全量diff）
<ul><li>vue3最长递增子序列</li></ul></li> <li>写法
<ul><li>vue2： options API</li> <li>vue3: compositeion API</li></ul></li> <li>Fragment</li> <li>Teleport</li> <li>Suspense</li> <li>ts支持</li> <li>自定义渲染器 createRenderer</li> <li>monorepo源码管理</li> <li>模板编译优化</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/frame/vue/my-vue2-ssr.html" class="prev">
          服务端渲染
        </a></span> <span class="next"><a href="/blog/frame/qiankun/">
          乾坤
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8d2d898d.js" defer></script><script src="/blog/assets/js/2.f81d762c.js" defer></script><script src="/blog/assets/js/5.f796fdc3.js" defer></script>
  </body>
</html>
