<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>作用域和闭包 | 答案的前端博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8cb9eb99.css" as="style"><link rel="preload" href="/blog/assets/js/app.316b283a.js" as="script"><link rel="preload" href="/blog/assets/js/2.6d1c2cae.js" as="script"><link rel="preload" href="/blog/assets/js/29.59f82477.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.09d0c0ad.js"><link rel="prefetch" href="/blog/assets/js/11.24e9fe90.js"><link rel="prefetch" href="/blog/assets/js/12.75d2d3f3.js"><link rel="prefetch" href="/blog/assets/js/13.a6ce19dc.js"><link rel="prefetch" href="/blog/assets/js/14.51ef2693.js"><link rel="prefetch" href="/blog/assets/js/15.55a3495e.js"><link rel="prefetch" href="/blog/assets/js/16.6c754bba.js"><link rel="prefetch" href="/blog/assets/js/17.237b629b.js"><link rel="prefetch" href="/blog/assets/js/18.ada2be0d.js"><link rel="prefetch" href="/blog/assets/js/19.38085e55.js"><link rel="prefetch" href="/blog/assets/js/20.9523a74b.js"><link rel="prefetch" href="/blog/assets/js/21.8aa5553c.js"><link rel="prefetch" href="/blog/assets/js/22.6ed952cf.js"><link rel="prefetch" href="/blog/assets/js/23.1784260c.js"><link rel="prefetch" href="/blog/assets/js/24.db8ec6bb.js"><link rel="prefetch" href="/blog/assets/js/25.bc201dd7.js"><link rel="prefetch" href="/blog/assets/js/26.edfef321.js"><link rel="prefetch" href="/blog/assets/js/27.19fddf7c.js"><link rel="prefetch" href="/blog/assets/js/28.22a4014c.js"><link rel="prefetch" href="/blog/assets/js/3.c9f56c6c.js"><link rel="prefetch" href="/blog/assets/js/30.cbd4a978.js"><link rel="prefetch" href="/blog/assets/js/31.7807f40d.js"><link rel="prefetch" href="/blog/assets/js/32.dda6423b.js"><link rel="prefetch" href="/blog/assets/js/33.a4739297.js"><link rel="prefetch" href="/blog/assets/js/34.04f726b5.js"><link rel="prefetch" href="/blog/assets/js/35.c62748ec.js"><link rel="prefetch" href="/blog/assets/js/36.a78f507b.js"><link rel="prefetch" href="/blog/assets/js/37.fd62bf47.js"><link rel="prefetch" href="/blog/assets/js/38.06fcc9c1.js"><link rel="prefetch" href="/blog/assets/js/39.0a7b7f84.js"><link rel="prefetch" href="/blog/assets/js/4.19804a3e.js"><link rel="prefetch" href="/blog/assets/js/40.d58cb4c1.js"><link rel="prefetch" href="/blog/assets/js/41.47168c6d.js"><link rel="prefetch" href="/blog/assets/js/42.b2e11b0a.js"><link rel="prefetch" href="/blog/assets/js/43.8891e966.js"><link rel="prefetch" href="/blog/assets/js/44.4d9b286c.js"><link rel="prefetch" href="/blog/assets/js/45.e731ef57.js"><link rel="prefetch" href="/blog/assets/js/46.3c551d9a.js"><link rel="prefetch" href="/blog/assets/js/47.72d6164f.js"><link rel="prefetch" href="/blog/assets/js/48.47ebf03a.js"><link rel="prefetch" href="/blog/assets/js/49.03128381.js"><link rel="prefetch" href="/blog/assets/js/5.f292579a.js"><link rel="prefetch" href="/blog/assets/js/50.9bc00e34.js"><link rel="prefetch" href="/blog/assets/js/51.faefd0e5.js"><link rel="prefetch" href="/blog/assets/js/52.18ebfe08.js"><link rel="prefetch" href="/blog/assets/js/53.f1224b13.js"><link rel="prefetch" href="/blog/assets/js/54.b190a2c2.js"><link rel="prefetch" href="/blog/assets/js/55.0b40f8fd.js"><link rel="prefetch" href="/blog/assets/js/56.fc598de0.js"><link rel="prefetch" href="/blog/assets/js/57.05887b48.js"><link rel="prefetch" href="/blog/assets/js/58.86c76d0c.js"><link rel="prefetch" href="/blog/assets/js/59.ac9c285f.js"><link rel="prefetch" href="/blog/assets/js/6.d7ec18fb.js"><link rel="prefetch" href="/blog/assets/js/60.6949514d.js"><link rel="prefetch" href="/blog/assets/js/61.221b709c.js"><link rel="prefetch" href="/blog/assets/js/62.68244966.js"><link rel="prefetch" href="/blog/assets/js/63.99fd5137.js"><link rel="prefetch" href="/blog/assets/js/64.901edaa6.js"><link rel="prefetch" href="/blog/assets/js/65.43f54825.js"><link rel="prefetch" href="/blog/assets/js/7.8bb0a382.js"><link rel="prefetch" href="/blog/assets/js/8.65be3530.js"><link rel="prefetch" href="/blog/assets/js/9.83554b82.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8cb9eb99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">答案的前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/basic/" class="nav-link router-link-active">
    基础篇
  </a></div><div class="nav-item"><a href="/blog/frame/" class="nav-link">
    框架篇
  </a></div><div class="nav-item"><a href="/blog/browser/" class="nav-link">
    浏览器
  </a></div><div class="nav-item"><a href="/blog/engine/" class="nav-link">
    工程化
  </a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
    算法
  </a></div><div class="nav-item"><a href="/blog/solutions/" class="nav-link">
    解决方案
  </a></div><div class="nav-item"><a href="/blog/node-md/" class="nav-link">
    node
  </a></div><div class="nav-item"><a href="/blog/resume.html" class="nav-link">
    简历
  </a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/basic/" class="nav-link router-link-active">
    基础篇
  </a></div><div class="nav-item"><a href="/blog/frame/" class="nav-link">
    框架篇
  </a></div><div class="nav-item"><a href="/blog/browser/" class="nav-link">
    浏览器
  </a></div><div class="nav-item"><a href="/blog/engine/" class="nav-link">
    工程化
  </a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
    算法
  </a></div><div class="nav-item"><a href="/blog/solutions/" class="nav-link">
    解决方案
  </a></div><div class="nav-item"><a href="/blog/node-md/" class="nav-link">
    node
  </a></div><div class="nav-item"><a href="/blog/resume.html" class="nav-link">
    简历
  </a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/basic/" aria-current="page" class="sidebar-link">数据类型</a></li><li><a href="/blog/basic/tranform.html" class="sidebar-link">类型转换</a></li><li><a href="/blog/basic/grammar.html" class="sidebar-link">语法篇</a></li><li><a href="/blog/basic/function.html" class="sidebar-link">函数式编程</a></li><li><a href="/blog/basic/async.html" class="sidebar-link">异步编程</a></li><li><a href="/blog/basic/array.html" class="sidebar-link">数组</a></li><li><a href="/blog/basic/object.html" class="sidebar-link">Object</a></li><li><a href="/blog/basic/context.html" class="sidebar-link">执行上下文</a></li><li><a href="/blog/basic/scope.html" aria-current="page" class="active sidebar-link">作用域和闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#资料" class="sidebar-link">资料</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#作用域" class="sidebar-link">作用域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#分类" class="sidebar-link">分类</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#例子" class="sidebar-link">例子</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#作用域链" class="sidebar-link">作用域链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#完整执行流程" class="sidebar-link">完整执行流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#闭包" class="sidebar-link">闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#用处" class="sidebar-link">用处</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#缺点" class="sidebar-link">缺点</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#常见的内存泄漏" class="sidebar-link">常见的内存泄漏</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#闭包执行过程" class="sidebar-link">闭包执行过程</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#块级作用域" class="sidebar-link">块级作用域</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#例子-2" class="sidebar-link">例子</a></li><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#完整的执行上下文" class="sidebar-link">完整的执行上下文</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/basic/scope.html#执行过程" class="sidebar-link">执行过程</a></li></ul></li></ul></li><li><a href="/blog/basic/this.html" class="sidebar-link">this</a></li><li><a href="/blog/basic/prototype.html" class="sidebar-link">原型/原型链</a></li><li><a href="/blog/basic/write.html" class="sidebar-link">手写系列</a></li><li><a href="/blog/basic/cg.html" class="sidebar-link">内存管理</a></li><li><a href="/blog/basic/question.html" class="sidebar-link">题目</a></li><li><a href="/blog/basic/ts.html" class="sidebar-link">Typescript</a></li><li><a href="/blog/basic/css.html" class="sidebar-link">css</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="作用域和闭包"><a href="#作用域和闭包" class="header-anchor">#</a> 作用域和闭包</h1> <h2 id="资料"><a href="#资料" class="header-anchor">#</a> 资料</h2> <ul><li>https://muyiy.cn/blog/2/2.1.html#%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE</li></ul> <h2 id="作用域"><a href="#作用域" class="header-anchor">#</a> 作用域</h2> <blockquote><p>作用域规定了如何查找变量，也就是确定当前执行代码对变量的访问权限。</p></blockquote> <h3 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h3> <blockquote><p>js采用静态作用域(语法作用域)</p></blockquote> <ul><li>静态作用域(词法作用域): 函数的作用域在<code>函数定义</code>的时候就决定</li> <li>动态作用域：函数的作用域是在<code>函数调用</code>的时候才决定的。</li></ul> <h3 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// js采用静态作用域，函数定义时就决定了作用域</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 1</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;global scope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;local scope&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义时决定作用域： </span>
    <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// local scope</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;global scope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;local scope&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// local scope</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="作用域链"><a href="#作用域链" class="header-anchor">#</a> 作用域链</h2> <p>当查找变量或者函数时，会先从<code>当前上下文的变量对象</code>中查找，如果没有找到，就会从父级(词法层面上的父级)执行上下文的变量对象中查找，一直找到全局执行上下文的变量对象，也就是全局对象。这样由多个执行上下文的变量对象构成的链表就叫做作用域链。</p> <h3 id="完整执行流程"><a href="#完整执行流程" class="header-anchor">#</a> 完整执行流程</h3> <ul><li>函数声明时用[[scope]]会记录当前的作用域链(重点)</li> <li>初始化执行上下文
<ul><li>变量对象
<ul><li>形参初始化</li> <li>函数声明</li> <li>变量声明：与函数名一样不会覆盖</li></ul></li> <li>作用域链：
<ul><li>用函数[[scope]]去初始化作用域链</li> <li>将当前变量对象压入作用域链顶端</li></ul></li></ul></li></ul> <blockquote><p>由于js采用静态作用域, 函数定义时就决定作用域 (用父级作用域和当前作用域去初始化当前函数的作用域链)</p></blockquote> <p><strong>示例代码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;global scope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;local scope&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token string">'tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>伪代码执行</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;global scope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkscope</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;local scope&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token string">'tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">ExectionContext</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">// 创建全局执行上下文</span>
<span class="token keyword">interface</span> <span class="token class-name">GlobalExectionContext</span> <span class="token punctuation">{</span>
    <span class="token constant">VO</span><span class="token operator">:</span> Window <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
        scope<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
        checkscope<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
            <span class="token comment">// 函数定义时就决定了其作用域</span>
            <span class="token string-property property">'[[Scopes]]'</span><span class="token operator">:</span> <span class="token punctuation">[</span>GlobalExectionContext<span class="token punctuation">[</span><span class="token string">'VO'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 当前执行上下文</span>
<span class="token comment">// ExectionContext = [GlobalExectionContext]</span>

<span class="token comment">// 执行checkscope('tom')</span>

<span class="token comment">// 创建checkscope执行上文</span>
<span class="token keyword">interface</span> <span class="token class-name">CheckscopeExectionContext</span> <span class="token punctuation">{</span>
    <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'tom'</span><span class="token punctuation">,</span>
        scope<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
        f<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
            <span class="token string-property property">'[[Scopes]]'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                CheckscopeExectionContext<span class="token punctuation">[</span><span class="token string">'AO'</span><span class="token punctuation">]</span>
                GlobalExectionContext<span class="token punctuation">[</span><span class="token string">'VO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">'[[Scopes]]'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// ...GlobalExectionContext['VO']['checkscope']['[[Scopes]]']</span>
        GlobalExectionContext<span class="token punctuation">[</span><span class="token string">'VO'</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 当前执行上下文</span>
<span class="token comment">// ExectionContext = [GlobalExectionContext, CheckscopeExectionContext]</span>

<span class="token comment">// 执行f()</span>
<span class="token keyword">interface</span> <span class="token class-name">FExectionContext</span> <span class="token punctuation">{</span>
    <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">'[[Scopes]]'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        CheckscopeExectionContext<span class="token punctuation">[</span><span class="token string">'AO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// ...CheckscopeExectionContext['AO']['f']['[[Scopes]]']</span>
        GlobalExectionContext<span class="token punctuation">[</span><span class="token string">'VO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 当前执行上下文</span>
<span class="token comment">// ExectionContext = [GlobalExectionContext, CheckscopeExectionContext, FExectionContext]</span>

<span class="token comment">// f函数里面的scope就会从 当前变量对象(AO) 和 [[Scopes]] 里面去一层层找scope变量的值</span>
</code></pre></div><h2 id="闭包"><a href="#闭包" class="header-anchor">#</a> 闭包</h2> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <ul><li>闭包是指那些能够访问自由变量的函数。</li> <li>闭包是指有权访问另外一个函数作用域中的变量的函数</li></ul> <p><strong>自由变量</strong></p> <blockquote><p>自由变量是指在函数中使用的，但既不是函数参数也不是函数的局部变量的变量。
可以在另外一个作用域中调用一个函数的内部函数并访问到该函数作用域中的成员</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makePower</span><span class="token punctuation">(</span><span class="token parameter">power</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> power<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> power2 <span class="token operator">=</span> <span class="token function">makePower</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">power2</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="用处"><a href="#用处" class="header-anchor">#</a> 用处</h3> <ul><li>可以读取函数内部的变量，</li> <li>让这些变量始终保持在内存中</li> <li>是封装对象的私有属性和私有方法</li> <li>避免全局变量污染</li></ul> <h3 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h3> <ul><li>会常驻内存，会增大内存使用量，使用不当很容易造成内存泄露</li></ul> <h3 id="常见的内存泄漏"><a href="#常见的内存泄漏" class="header-anchor">#</a> 常见的内存泄漏</h3> <ul><li>意外的全局变量</li> <li>被遗忘的计时器</li> <li>闭包</li></ul> <h2 id="闭包执行过程"><a href="#闭包执行过程" class="header-anchor">#</a> 闭包执行过程</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;global scope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;local scope&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li>执行全局代码，创建全局执行上下文，压入执行上下文栈</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  globalContext
]
</code></pre></div><ol start="2"><li>全局执行上下文初始化</li></ol> <div class="language- extra-class"><pre class="language-text"><code>globalContext = {
  AO:{
    // window
    ...[global],
    // 函数声明
    checkscope: reference to function checkscope(){}
    // 变量声明
    scope: undefined
  },
  Scope: [globalContext.VO],
  this: globalContext.AO
}
</code></pre></div><ol start="3"><li>遇到checkscope函数，保存当前的作用域</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// [globalContext.VO]
checkscope.[[scope]] = globalContext.Scope
</code></pre></div><ol start="4"><li>执行checkscope函数，创建checkscope函数上下文,压入执行上下文栈</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  checkscopeContext,
  globalContext
]
</code></pre></div><ol start="5"><li>checkscope函数上下文初始化</li></ol> <div class="language- extra-class"><pre class="language-text"><code>checkscopeContext = {
  AO: {
    // 形参
    arguments:{
      0: 'allen',
      length: 0
    },
    name: 'allen',
    // 函数声明
    f: reference to function f(){}
    // 变量声明
    scope: undefined
  },
  // 第一步: 用checkscope的[[scope]]属性初始化作用域链
  // 第二部：将checkscope.AO压入Scope的顶端
  // [checkscopeContext.Ao,globalContext.VO]
  Scope: [checkscopeContext.Ao, ...checkscope.[[scope]]],
  this: undefined
}
</code></pre></div><ol start="6"><li>函数f声明，保存作用域链到函数内部属性[[scope]]</li></ol> <blockquote><p>这句超级无敌重要</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>// [checkscopeContext.Ao, globalContext.VO]
f.[[scope]] = checkscopeContext.Scope
</code></pre></div><ol start="7"><li>checkscope函数执行完时checkscopeContext</li></ol> <div class="language- extra-class"><pre class="language-text"><code>checkscopeContext = {
  AO: {
    arguments:{
      0: 'allen',
      length: 0
    },
    name: 'allen',
    f: reference to function f(){}
    scope: 'local scope'
  },
  // [checkscopeContext.Ao,globalContext.VO]
  Scope: [checkscopeContext.Ao, ...checkscope.[[scope]]],
  this: undefined
}
</code></pre></div><ol start="8"><li>执行完毕后，从执行上下文栈中弹出</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  globalContext
]
</code></pre></div><ol start="9"><li>执行foo函数，创建foo函数执行上下文，压入执行上下文栈</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  fooContext,
  globalContext
]
</code></pre></div><ol start="9"><li>foo函数执行上下文初始化,创建变量对象，作用域链，this</li></ol> <div class="language- extra-class"><pre class="language-text"><code>fooContext = {
  AO: {
    // 形参
    arguments:{
      length:0
    },
    // 函数声明
    // 变量声明
  },
  // 第一步： 用f函数的[[scope]] 来初始化作用域链
  // 第二部：将当前fooContext.AO添加到作用域顶端
  // [fooContext.AO, checkscopeContext.Ao,globalContext.VO]
  Scope: [fooContext.AO, ...f.[[scoped]]],
  this: undefined
}
</code></pre></div><ol start="10"><li>此时f(){return scope}就会从foo的作用域链上去找</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// 在checkscopeContext.Ao就找到scope为local scope
[fooContext.AO, checkscopeContext.Ao,globalContext.VO]
</code></pre></div><ol start="11"><li>f函数执行完毕,从执行上下文栈弹出</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  globalContext
]
</code></pre></div><h2 id="块级作用域"><a href="#块级作用域" class="header-anchor">#</a> 块级作用域</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">var</span> data<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">LetGlobalContext</span> <span class="token punctuation">{</span>
    <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        data<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">BlockContext</span> <span class="token punctuation">{</span>
    <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        i<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
        <span class="token comment">// Scopes: [LetGlobalContext.VO, BlockContext.VO]</span>
        <span class="token comment">// 所以i的存在于BlockContext.VO</span>
        <span class="token function-variable function">unknowFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="例子-2"><a href="#例子-2" class="header-anchor">#</a> 例子</h2> <p><strong>例子0</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>执行流程</strong></p> <blockquote><p>data[0]Context.AO中没有i变量，往上找就找到了globalContext.VO</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>data[0].Scope = [
  data0Context.AO,
  globalContext.VO
]

data0Context.AO = {
  arguments:{
    length:0
  },
}

globalContext.VO = {
  i:3,
  // ...其他
}
</code></pre></div><p><strong>例子1</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>执行流程</strong></p> <div class="language- extra-class"><pre class="language-text"><code>// data[0]作用域链

data[0].Scope = [
  data0Context.AO,
  data[0]匿名函数Context.AO,
  globalContext.VO
]

data0Context.AO = {
  arguments:{
    length: 0
  },
}

data[0]匿名函数Context.AO = {
  arguments:{
    length: 1
  },
  i: 0
}

globalContext.VO = {
  // ...其他
  i: 3
}
</code></pre></div><h2 id="完整的执行上下文"><a href="#完整的执行上下文" class="header-anchor">#</a> 完整的执行上下文</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 代码块</span>
<span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;global scope&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token string">&quot;local scope&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">checkscope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="执行过程"><a href="#执行过程" class="header-anchor">#</a> 执行过程</h3> <ol><li>执行全局代码。创建全局执行上下文，并把全局上下文压入执行上下文栈</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>ECStack <span class="token operator">=</span> <span class="token punctuation">[</span>
  globalContext
<span class="token punctuation">]</span>
</code></pre></div><ol start="2"><li>全局上下文初始化</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>globalContext <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 变量对象</span>
  <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">[</span>global<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 作用域链</span>
  <span class="token literal-property property">Scope</span><span class="token operator">:</span> <span class="token punctuation">[</span>globalContext<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// this</span>
  <span class="token keyword">this</span><span class="token operator">:</span> globalContext<span class="token punctuation">.</span><span class="token constant">VO</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>checkscope创建，保存作用域链到函数内部属性[[scope]]</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>checkscope<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  globalContext<span class="token punctuation">.</span><span class="token constant">VO</span>
<span class="token punctuation">]</span>
</code></pre></div><ol start="4"><li>执行checkscope函数，创建checkscope函数执行上下文，将checkscope函数执行上下文压入执行栈</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>ECStack <span class="token operator">=</span> <span class="token punctuation">[</span>
  checkscopeContext<span class="token punctuation">,</span>
  globalContext
<span class="token punctuation">]</span>
</code></pre></div><ol start="5"><li>checkscope函数执行上下文初始化</li></ol> <div class="language- extra-class"><pre class="language-text"><code>checkscopeContext = {
  // 1. 复制函数[[scope]]创建作用域
  Scope: [globalContext.VO],
  // 2. 创建活动对象AO
  AO: {
    // 3. 创建arguments
    arguments: {
      length: 0
    },
    // 4. 初始化形参
    // 5. 函数声明
    f: function(){}
    // 6. 变量声明
    scope: undefined
  }
}

// 7. 将活动对象压入checkscope作用域链顶端
checkscopeContext.Scope.unshift(checkscopeContext.AO)
</code></pre></div><ol start="6"><li>f函数创建，保存作用域链到f函数内部属性[[scope]]</li></ol> <div class="language- extra-class"><pre class="language-text"><code>f.[[scope]] = checkscopeContext.Scope
</code></pre></div><ol start="7"><li>执行f函数，创建f函数执行上下文，将f函数执行上下文压入执行上下文</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  fContext,
  checkscopeContext,
  globalContext
]
</code></pre></div><ol start="8"><li>f函数执行上下文初始化</li></ol> <div class="language- extra-class"><pre class="language-text"><code>fContext = {
  // 1. 复制f函数[[scope]]创建作用域
  Scope: [checkscopeContext.VO,globalContext.VO],
  // 2. 创建活动对象AO
  AO: {
    // 3. 创建arguments
    arguments: {
      length: 0
    },
    // 4. 初始化形参
    // 5. 函数声明
    // 6. 变量声明
  }
}

// 7. 将活动对象压入f作用域链顶端
// fContext.Scope = [fContext.AO,checkscopeContext.VO,globalContext.VO]
fContext.Scope.unshift(fContext.AO)   
</code></pre></div><ol start="9"><li>执行f函数</li></ol> <blockquote><p>沿着fContext.Scope找scope</p></blockquote> <ol start="10"><li>f函数执行完毕，弹出</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  checkscopeContext,
  globalContext
]
</code></pre></div><ol start="11"><li>checkscope函数执行完毕，弹出</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ECStack = [
  globalContext
]
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/basic/context.html" class="prev">
          执行上下文
        </a></span> <span class="next"><a href="/blog/basic/this.html">
          this
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.316b283a.js" defer></script><script src="/blog/assets/js/2.6d1c2cae.js" defer></script><script src="/blog/assets/js/29.59f82477.js" defer></script>
  </body>
</html>
